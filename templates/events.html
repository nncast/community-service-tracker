{% extends "base.html" %}
{% block title %}Events{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/event.css') }}">

<div class="dashboard-header">
    <h1>Event Management</h1>
    <p class="subtitle">Create and manage events for student attendance</p>
</div>

<!-- Create New Event -->
<div class="content-card">
    <div class="card-header">
        <h3>Create New Event</h3>
    </div>
    <div class="card-content">
        <form method="post" action="{{ url_for('add_event') }}" class="event-form">
            <div class="form-group">
                <label>Event Name</label>
                <input type="text" name="name" required placeholder="Enter event name">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" name="date" required>
                </div>
                <div class="form-group">
                    <label>Required Hours</label>
                    <input type="number" step="0.1" name="required_hours" value="2.0" required min="0.1">
                </div>
            </div>

            <div class="form-group">
                <label>Target Year Levels</label>
                <div class="checkbox-group" id="yearLevelContainer" style="display:none;">
                    <label class="checkbox-label all-checkbox">
                        <input type="checkbox" name="year_levels" value="all" onclick="toggleYearSelection(this)">
                        <span class="checkmark"></span>
                        All Year Levels
                    </label>
                    <div class="year-level-grid" id="yearLevelGrid">
                        {% for yl in year_levels %}
                        <label class="checkbox-label" data-academic-year="{{ yl.academic_year_id }}">
                            <input type="checkbox" name="year_levels" value="{{ yl.id }}">
                            <span class="checkmark"></span>
                            {{ yl.level }}{% if yl.level == 1 %}st{% elif yl.level == 2 %}nd{% elif yl.level == 3 %}rd{% else %}th{% endif %} Year - {{ yl.section }}
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <button type="submit" class="btn-primary">
                <span class="btn-icon">â•</span>
                Create Event
            </button>
        </form>
    </div>
</div>

<!-- Existing Events -->
<div class="content-card">
    <div class="card-header">
        <h3>Existing Events</h3>
        <span class="event-count">{{ events|length }} event(s)</span>
    </div>
    <div class="card-content">

        <!-- Search & Filter -->
        <div class="filter-form" style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
            <input type="text" id="searchInput" placeholder="Search by event name..." style="padding: 5px;">
            <select id="yearFilter" style="padding: 5px;">
                <option value="">All Academic Years</option>
                {% for ay in academic_years %}
                <option value="{{ ay.year }}">{{ ay.year }}</option>
                {% endfor %}
            </select>
            <select id="semesterFilter" style="padding: 5px;">
                <option value="">All Semesters</option>
                <option value="1st Semester">1st Semester</option>
                <option value="2nd Semester">2nd Semester</option>
            </select>
        </div>

        {% set events_by_ay = {} %}
        {% for event in events %}
            {% set ay = event.semester.academic_year if event.semester else None %}
            {% if ay %}
                {% if events_by_ay[ay.year] is not defined %}
                    {% set _ = events_by_ay.update({ay.year: {'1st Semester': [], '2nd Semester': []}}) %}
                {% endif %}
                {% set _ = events_by_ay[ay.year][event.semester.name].append(event) %}
            {% endif %}
        {% endfor %}

        <div id="eventsTableWrapper">
            {% if events_by_ay %}
                {% for ay, sems in events_by_ay.items() %}
                <h4 class="ay-header">{{ ay }}</h4>
                <table class="events-table">
                    <thead>
                        <tr>
                            <th>Semester</th>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Date</th>
                            <th>Target Years</th>
                            <th>Required Hours</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sem_name, sem_events in sems.items() %}
                            {% for event in sem_events %}
                            <tr class="event-row" data-name="{{ event.name|lower }}" data-ay="{{ ay }}" data-semester="{{ sem_name }}">
                                {% if loop.first %}
                                <td rowspan="{{ sem_events|length }}">{{ sem_name }}</td>
                                {% endif %}
                                <td>{{ event.id }}</td>
                                <td>{{ event.name }}</td>
                                <td>{{ event.date.strftime('%b %d, %Y') }}</td>
                                <td>{{ event.target_years }}</td>
                                <td>{{ event.required_hours }}h</td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="{{ url_for('edit_event', event_id=event.id) }}" class="btn-edit" title="Edit Event">
                                            <span class="btn-icon">âœï¸</span>
                                        </a>
                                        <a href="{{ url_for('delete_event', event_id=event.id) }}" class="btn-delete" title="Delete Event" onclick="return confirm('Are you sure you want to delete this event?')">
                                            <span class="btn-icon">ğŸ—‘ï¸</span>
                                        </a>
                                        <a href="{{ url_for('event_attendance', event_id=event.id) }}" class="btn-attendance" title="View Attendance">
                                            <span class="btn-icon">ğŸ‘¥</span>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
                {% endfor %}
            {% else %}
            <div class="empty-state">
                <span class="empty-icon">ğŸ“…</span>
                <p>No events created yet.</p>
                <p class="subtext">Create your first event using the form above.</p>
            </div>
            {% endif %}
        </div>

    </div>
</div>
<script>
// Elements
const searchInput = document.getElementById('searchInput');
const yearFilter = document.getElementById('yearFilter');
const semesterFilter = document.getElementById('semesterFilter');
const eventsTableWrapper = document.getElementById('eventsTableWrapper');

// --- Prepare events data from table for filtering ---
const eventsData = {};

// Build eventsData object from table rows
document.querySelectorAll('#eventsTableWrapper .event-row').forEach(row => {
    const ay = row.dataset.ay;
    const sem = row.dataset.semester;
    const name = row.dataset.name;

    if (!eventsData[ay]) eventsData[ay] = {};
    if (!eventsData[ay][sem]) eventsData[ay][sem] = [];
    eventsData[ay][sem].push(name);
});

// --- Table filtering ---
function filterEventsTable() {
    const searchValue = searchInput.value.toLowerCase();
    const selectedYear = yearFilter.value;
    const selectedSemester = semesterFilter.value;

    document.querySelectorAll('#eventsTableWrapper .event-row').forEach(row => {
        const name = row.dataset.name;
        const ay = row.dataset.ay;
        const sem = row.dataset.semester;

        const matchesSearch = name.includes(searchValue);
        const matchesYear = selectedYear === "" || ay === selectedYear;
        const matchesSemester = selectedSemester === "" || sem === selectedSemester;

        row.style.display = (matchesSearch && matchesYear && matchesSemester) ? "" : "none";
    });

    // Hide academic year headers if no visible rows
    document.querySelectorAll('#eventsTableWrapper .ay-header').forEach(header => {
        const rows = Array.from(document.querySelectorAll(`#eventsTableWrapper .event-row[data-ay="${header.textContent}"]`));
        header.style.display = rows.some(r => r.style.display !== 'none') ? "" : "none";
    });
}

// --- Dropdown filtering (optional) ---
function updateEventDropdown() {
    const dropdown = document.getElementById('eventSelect');
    if (!dropdown) return; // skip if no dropdown

    dropdown.innerHTML = ""; // clear previous options

    const selectedYear = yearFilter.value;
    const selectedSemester = semesterFilter.value;

    if (!selectedYear || !eventsData[selectedYear]) return;

    if (selectedSemester) {
        (eventsData[selectedYear][selectedSemester] || []).forEach(ev => {
            const option = document.createElement('option');
            option.value = ev;
            option.textContent = ev;
            dropdown.appendChild(option);
        });
    } else {
        // all semesters
        Object.values(eventsData[selectedYear]).forEach(eventList => {
            eventList.forEach(ev => {
                const option = document.createElement('option');
                option.value = ev;
                option.textContent = ev;
                dropdown.appendChild(option);
            });
        });
    }
}

// --- Event listeners for filters ---
searchInput.addEventListener('input', () => {
    filterEventsTable();
    updateEventDropdown();
});
yearFilter.addEventListener('change', () => {
    filterEventsTable();
    updateEventDropdown();
});
semesterFilter.addEventListener('change', () => {
    filterEventsTable();
    updateEventDropdown();
});

// --- Year-level and date logic for event creation ---
const academicYears = [
    {% for ay in academic_years %}
    {
        id: {{ ay.id }},
        year: "{{ ay.year }}",
        semesters: [
            {% for sem in ay.semesters %}
            { start_date: "{{ sem.start_date }}", end_date: "{{ sem.end_date }}" }{% if not loop.last %},{% endif %}
            {% endfor %}
        ]
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

const dateInput = document.querySelector('input[name="date"]');
const yearLevelContainer = document.getElementById('yearLevelContainer');
const yearLevelLabels = document.querySelectorAll('#yearLevelGrid .checkbox-label');

function toggleYearSelection(allCheckbox) {
    const yearCheckboxes = document.querySelectorAll('input[name="year_levels"]:not([value="all"])');
    yearCheckboxes.forEach(cb => cb.checked = allCheckbox.checked);
}

document.querySelectorAll('input[name="year_levels"]:not([value="all"])').forEach(cb => {
    cb.addEventListener('change', () => {
        const allCheckbox = document.querySelector('input[name="year_levels"][value="all"]');
        const visibleCheckboxes = Array.from(document.querySelectorAll('input[name="year_levels"]:not([value="all"])'))
                                       .filter(c => !c.disabled);
        allCheckbox.checked = visibleCheckboxes.every(c => c.checked);
    });
});

dateInput.addEventListener('change', () => {
    if (!dateInput.value) {
        yearLevelContainer.style.display = 'none';
        return;
    }

    const selectedDate = new Date(dateInput.value + 'T00:00:00');
    yearLevelContainer.style.display = 'block';

    const matchingAY = academicYears.find(ay => {
        if (!ay.semesters.length) return false;
        const start = new Date(ay.semesters[0].start_date + 'T00:00:00');
        const end = new Date(ay.semesters[ay.semesters.length - 1].end_date + 'T00:00:00');
        return selectedDate >= start && selectedDate <= end;
    });

    yearLevelLabels.forEach(label => {
        const academicYearId = parseInt(label.dataset.academicYear, 10);
        const checkbox = label.querySelector('input');

        if (matchingAY && parseInt(matchingAY.id, 10) === academicYearId) {
            label.style.display = 'block';
            checkbox.checked = true;
            checkbox.disabled = false;
        } else {
            label.style.display = 'none';
            checkbox.checked = false;
            checkbox.disabled = true;
        }
    });

    // Update "All" checkbox
    const allCheckbox = document.querySelector('input[name="year_levels"][value="all"]');
    if (allCheckbox) {
        const visibleCheckboxes = Array.from(document.querySelectorAll('input[name="year_levels"]:not([value="all"])'))
                                       .filter(c => !c.disabled);
        allCheckbox.checked = visibleCheckboxes.length > 0 && visibleCheckboxes.every(c => c.checked);
        allCheckbox.disabled = visibleCheckboxes.length === 0;
    }
});
</script>


{% endblock %}
