{% extends "base.html" %}
{% block title %}Year Levels Management{% endblock %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/year_level.css') }}">

<div class="dashboard-header">
    <h1>Year Level Management</h1>
    <p class="subtitle">Manage year levels and sections for academic years</p>
</div>
<div class="content-card">
    <div class="card-header toggler" onclick="toggleAddYearLevel()">
        <h3>Add New Year Level</h3>
        <span id="toggle-icon-yl">‚ñº</span>
    </div>

    <div class="card-content" id="add-year-level-container" style="display: none;">
        <form method="post" action="{{ url_for('add_year_level') }}" class="year-level-form">
            
            <div class="form-row">
                <div class="form-group">
                    <label>Academic Year</label>
                    <select name="academic_year" required>
                        <option value="">Select Academic Year</option>
                        {% for ay in academic_years %}
                        <option value="{{ ay.id }}">{{ ay.year }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Level</label>
                    <input type="number" name="level" min="1" max="4" required placeholder="1-4">
                </div>
                
                <div class="form-group">
                    <label>Section</label>
                    <input type="text" name="section" required placeholder="Enter section">
                </div>
            </div>

            <button type="submit" class="btn-primary">
                <span class="btn-icon">‚ûï</span>
                Add Year Level
            </button>
        </form>
    </div>
</div>




<div class="content-card">
    <div class="card-header">
        <h3>Existing Year Levels</h3>
        <span class="year-level-count">{{ year_levels|length }} year level(s)</span>
    </div>

    <div class="card-content">

        <!-- Search inside the existing year levels container -->
        <!-- Search inside the existing year levels container -->
<div class="table-controls">
    <form method="get" action="{{ url_for('year_levels') }}" class="filter-form" id="autoFilterForm">
        <div class="filter-row">
            <div class="form-group">
                <label>Search</label>
                <input type="text" name="search" value="{{ search }}" placeholder="Search year levels..." id="searchInput">
            </div>
            
            <div class="form-group">
                <label>Academic Year</label>
                <select name="academic_year" id="yearFilter">
                    <option value="">All Academic Years</option>
                    {% for ay in academic_years %}
                    <option value="{{ ay.id }}" {% if ay_filter|int==ay.id %}selected{% endif %}>
                        {{ ay.year }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </form>
</div>

        <!-- end search -->

        <div class="table-container">
            <table class="year-levels-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Academic Year</th>
                        <th>Level</th>
                        <th>Section</th>
                        <th>Actions</th>
                    </tr>
                </thead>

                <tbody>
                    {% for yl in year_levels %}
                    <tr>
                        <form method="post" action="{{ url_for('edit_year_level', yl_id=yl.id) }}">
                            <td class="year-level-id">{{ yl.id }}</td>

                            <td>
                                <select name="academic_year" class="form-select">
                                    {% for ay in academic_years %}
                                    <option value="{{ ay.id }}" {% if yl.academic_year_id==ay.id %}selected{% endif %}>
                                        {{ ay.year }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </td>

                            <td>
                                <input type="number" name="level" value="{{ yl.level }}" min="1" max="4" class="form-input">
                            </td>

                            <td>
                                <input type="text" name="section" value="{{ yl.section }}" class="form-input">
                            </td>

                            <td class="actions">
                                <div class="action-buttons">
                                    <button type="submit" class="btn-update" title="Update">
                                        <span class="btn-icon">üíæ</span>
                                    </button>

                                    <a href="{{ url_for('delete_year_level', yl_id=yl.id) }}"
                                       class="btn-delete" title="Delete"
                                       onclick="return confirm('Are you sure you want to delete this year level?')">
                                        <span class="btn-icon">üóëÔ∏è</span>
                                    </a>
                                </div>
                            </td>
                        </form>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if not year_levels %}
        <div class="empty-state">
            <span class="empty-icon">üéì</span>
            <p>No year levels found.</p>
            <p class="subtext">Add your first year level using the form above.</p>
        </div>
        {% endif %}
    </div>
</div>


{% with messages = get_flashed_messages() %}
  {% if messages %}
    <div class="flashed-messages">
        {% for message in messages %}
            <div class="flash-message">{{ message }}</div>
        {% endfor %}
    </div>
  {% endif %}
{% endwith %}
<script>
    let searchTimer = null;
document.getElementById("searchInput").addEventListener("input", function () {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => {
        document.getElementById("autoFilterForm").submit();
    }, 300); // delay typing trigger
});

// submit form instantly when filter changes
document.getElementById("yearFilter").addEventListener("change", function () {
    document.getElementById("autoFilterForm").submit();
});
function toggleAddYearLevel() {
    const container = document.getElementById("add-year-level-container");
    const icon = document.getElementById("toggle-icon-yl");

    const isHidden = container.style.display === "none";
    container.style.display = isHidden ? "block" : "none";
    icon.textContent = isHidden ? "‚ñ≤" : "‚ñº";
}
</script>
{% endblock %}
