{% extends "base.html" %}
{% block title %}Users Management{% endblock %}
{% block content %}

<h2>
    Add User 
    <button type="button" id="toggleAddUser" style="margin-left:10px;">Show/Hide</button>
</h2>

<div id="addUserForm" style="display:none; margin-bottom:20px;">
    <form class="top-form" method="post" action="{{ url_for('add_user') }}">
        Username: <input type="text" name="username" required>
        Password: <input type="text" name="password" required>
        Role: 
        <select name="role">
            <option value="admin">Admin</option>
            <option value="officer">Officer</option>
        </select>
        <label class="switch">
            <input type="checkbox" name="status" checked>
            <span class="slider round"></span>
        </label>
        <button type="submit">Add</button>
    </form>
</div>

<h2>Existing Users</h2>

<!-- Search & Filter (auto) -->
<div style="margin-bottom:10px;">
    <form id="filterForm" method="get" action="{{ url_for('users') }}">
        Search Username: <input type="text" name="search" value="{{ search }}" id="searchInput">
        Role:
        <select name="role" id="roleSelect">
            <option value="">All</option>
            <option value="admin" {% if role_filter=='admin' %}selected{% endif %}>Admin</option>
            <option value="officer" {% if role_filter=='officer' %}selected{% endif %}>Officer</option>
        </select>
        Status:
        <select name="status" id="statusSelect">
            <option value="active" {% if status_filter=='active' %}selected{% endif %}>Active</option>
            <option value="inactive" {% if status_filter=='inactive' %}selected{% endif %}>Inactive</option>
            <option value="" {% if not status_filter %}selected{% endif %}>All</option>
        </select>
    </form>
</div>

<table border="1" cellpadding="5" cellspacing="0" style="width:100%; border-collapse: collapse;">
    <tr>
        <th>ID</th>
        <th>Username</th>
        <th>Password</th>
        <th>Role</th>
        <th>Status</th>
        <th>Created At</th>
        <th>Actions</th>
    </tr>
    {% for user in users %}
    <tr>
        <form method="post" action="{{ url_for('edit_user', user_id=user.id) }}">
            <td>{{ user.id }}</td>
            <td><input type="text" name="username" value="{{ user.username }}"></td>
            <td><input type="text" name="password" value="{{ user.password }}"></td>
            <td>
                <select name="role">
                    <option value="admin" {% if user.role=='admin' %}selected{% endif %}>Admin</option>
                    <option value="officer" {% if user.role=='officer' %}selected{% endif %}>Officer</option>
                </select>
            </td>
            <td>
                <label class="switch">
                    <input type="checkbox" name="status" {% if user.status=='active' %}checked{% endif %}>
                    <span class="slider round"></span>
                </label>
            </td>
            <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
            <td>
                <button type="submit">Update</button>
                <a href="{{ url_for('delete_user', user_id=user.id) }}" onclick="return confirm('Delete this user?')">Delete</a>
            </td>
        </form>
    </tr>
    {% endfor %}
</table>

{% with messages = get_flashed_messages() %}
  {% if messages %}
    <ul style="color: red;">
      {% for message in messages %}
        <li>{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}

<style>
/* Toggle switch */
.switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 24px;
}
.switch input { 
  opacity: 0;
  width: 0;
  height: 0;
}
.slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: #ccc;
  transition: 0.3s;
  border-radius: 24px;
}
.slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.3s;
  border-radius: 50%;
}
input:checked + .slider {
  background-color: #4CAF50;
}
input:checked + .slider:before {
  transform: translateX(26px);
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const form = document.getElementById("filterForm");
    const searchInput = document.getElementById("searchInput");
    const roleSelect = document.getElementById("roleSelect");
    const statusSelect = document.getElementById("statusSelect");
    const toggleButton = document.getElementById("toggleAddUser");
    const addFormDiv = document.getElementById("addUserForm");

    // Auto-submit filters
    searchInput.addEventListener("keyup", function() { form.submit(); });
    roleSelect.addEventListener("change", function() { form.submit(); });
    statusSelect.addEventListener("change", function() { form.submit(); });

    // Toggle Add User form
    toggleButton.addEventListener("click", function() {
        addFormDiv.style.display = addFormDiv.style.display === "none" ? "block" : "none";
    });
});
</script>

{% endblock %}
