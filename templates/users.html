{% extends "base.html" %}
{% block title %}Users Management{% endblock %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/users.css') }}">

<div class="dashboard-header">
    <h1>User Management</h1>
    <p class="subtitle">Manage system users and permissions</p>
</div>

<!-- Add New User Card (Toggleable) -->
<div class="content-card">
    <div class="card-header" style="display:flex; justify-content:space-between; align-items:center;">
        <h3>Add New User</h3>
        <button type="button" id="toggleAddUser" class="btn-secondary">Add User</button>
    </div>
    <div class="card-content" id="addUserForm" style="display:none;">
        <form method="post" action="{{ url_for('add_user') }}" class="user-form">
            <div class="form-row">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" name="username" required placeholder="Enter username">
                </div>
                
                <div class="form-group">
                    <label>Password</label>
                    <input type="text" name="password" required placeholder="Enter password">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Role</label>
                    <select name="role">
                        <option value="admin">Admin</option>
                        <option value="officer">Officer</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Status</label>
                    <select name="status">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
            </div>

            <button type="submit" class="btn-primary">

                Add User
            </button>
        </form>
    </div>
</div>

<!-- Existing Users Card -->
<div class="content-card">
    <div class="card-header">
        <h3>Existing Users</h3>
        <span class="user-count">{{ users|length }} user(s)</span>
    </div>
    <div class="card-content">

        <!-- Filters -->
<div class="filter-row" style="margin-bottom:20px; display:flex; gap:16px; align-items:flex-end;">
    <form id="filterForm" method="get" action="{{ url_for('users') }}" class="filter-form" style="display:flex; gap:16px; align-items:flex-end; width:100%;">
        <div class="form-group" style="flex:1;">
            <label>Search Username</label>
            <input type="text" name="search" value="{{ search }}" id="searchInput" placeholder="Search username...">
        </div>
        <div class="form-group" style="width:150px;">
            <label>Role</label>
            <select name="role" id="roleSelect">
                <option value="">All Roles</option>
                <option value="admin" {% if role_filter=='admin' %}selected{% endif %}>Admin</option>
                <option value="officer" {% if role_filter=='officer' %}selected{% endif %}>Officer</option>
            </select>
        </div>
        <div class="form-group" style="width:150px;">
            <label>Status</label>
            <select name="status" id="statusSelect">
                <option value="">All Status</option>
                <option value="active" {% if status_filter=='active' %}selected{% endif %}>Active</option>
                <option value="inactive" {% if status_filter=='inactive' %}selected{% endif %}>Inactive</option>
            </select>
        </div>
    </form>
</div>


        <!-- Users Table -->
        <div class="table-container">
            <table class="users-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Password</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Created At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <form method="post" action="{{ url_for('edit_user', user_id=user.id) }}">
                            <td class="user-id">{{ user.id }}</td>
                            <td><input type="text" name="username" value="{{ user.username }}" class="form-input"></td>
                            <td><input type="text" name="password" placeholder="Enter new password (leave blank to keep)" class="form-input"></td>
                            <td>
                                <select name="role" class="form-select">
                                    <option value="admin" {% if user.role=='admin' %}selected{% endif %}>Admin</option>
                                    <option value="officer" {% if user.role=='officer' %}selected{% endif %}>Officer</option>
                                </select>
                            </td>
                            <td>
                                <label class="switch">
                                    <input type="checkbox" name="status" value="active" {% if user.status=='active' %}checked{% endif %}>
                                    <span class="slider round"></span>
                                </label>
                            </td>
                            <td class="created-at">{{ user.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td class="actions">
                                <div class="action-buttons">
                                    <button type="submit" class="btn-update" title="Update User">
                                        <span class="btn-icon">üíæ</span>
                                    </button>
                                    <a href="{{ url_for('delete_user', user_id=user.id) }}" class="btn-delete" title="Delete User" onclick="return confirm('Are you sure you want to delete this user?')">
                                        <span class="btn-icon">üóëÔ∏è</span>
                                    </a>
                                </div>
                            </td>
                        </form>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if not users %}
        <div class="empty-state">
            <span class="empty-icon">üë•</span>
            <p>No users found.</p>
            <p class="subtext">Add your first user using the form above.</p>
        </div>
        {% endif %}

    </div>
</div>

{% with messages = get_flashed_messages() %}
  {% if messages %}
    <div class="flashed-messages">
        {% for message in messages %}
            <div class="flash-message">{{ message }}</div>
        {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<!-- Toggle and Filter Scripts -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Add User toggle
    const toggleButton = document.getElementById("toggleAddUser");
    const addFormDiv = document.getElementById("addUserForm");
    toggleButton.addEventListener("click", function() {
        addFormDiv.style.display = (addFormDiv.style.display === "none" || addFormDiv.style.display === "") ? "block" : "none";
    });

    // Auto-submit filters
    const filterForm = document.getElementById("filterForm");
    const searchInput = document.getElementById("searchInput");
    const roleSelect = document.getElementById("roleSelect");
    const statusSelect = document.getElementById("statusSelect");

    searchInput.addEventListener("keyup", function() { filterForm.submit(); });
    roleSelect.addEventListener("change", function() { filterForm.submit(); });
    statusSelect.addEventListener("change", function() { filterForm.submit(); });
});
</script>

<!-- Toggle switch CSS -->
<style>
.switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 24px;
}
.switch input { opacity: 0; width: 0; height: 0; }
.slider {
  position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
  background-color: #ccc; transition: 0.3s; border-radius: 24px;
}
.slider:before {
  position: absolute; content: ""; height: 18px; width: 18px;
  left: 3px; bottom: 3px; background-color: white; transition: 0.3s; border-radius: 50%;
}
input:checked + .slider { background-color: #4CAF50; }
input:checked + .slider:before { transform: translateX(26px); }
</style>

{% endblock %}
